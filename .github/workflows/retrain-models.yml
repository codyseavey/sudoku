name: Retrain ML Models

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      model_type:
        description: 'Which model to retrain'
        required: true
        type: choice
        options:
          - digit-cnn
          - boundary-classifier
          - cage-sum-cnn
          - all

  # Uncomment to enable weekly retraining:
  # schedule:
  #   - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC

jobs:
  retrain-models:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push commits

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: extraction_service/requirements.txt

      - name: Install dependencies
        run: |
          cd extraction_service
          pip install -r requirements.txt

      - name: Extract training cells
        if: inputs.model_type == 'digit-cnn' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Extracting training cells..."
          python extract_training_cells.py

      - name: Train Digit CNN
        if: inputs.model_type == 'digit-cnn' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Training Digit CNN classifier..."
          python train_digit_cnn.py --epochs 20 --batch-size 32
          echo "Digit CNN training complete"
          ls -lh models/digit_cnn.pth

      - name: Extract boundary training data
        if: inputs.model_type == 'boundary-classifier' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Extracting boundary training data..."
          python extract_boundary_training_data.py

      - name: Train Boundary Classifier
        if: inputs.model_type == 'boundary-classifier' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Training boundary classifier..."
          python train_boundary_classifier.py
          echo "Boundary classifier training complete"
          ls -lh models/boundary_classifier_rf.pkl models/boundary_scaler.pkl

      - name: Extract cage sum training data
        if: inputs.model_type == 'cage-sum-cnn' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Extracting cage sum training data..."
          python extract_cage_sum_training_data.py
          echo "Cage sum data extraction complete"

      - name: Prepare cage sum CNN data
        if: inputs.model_type == 'cage-sum-cnn' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Preparing cage sum CNN data..."
          python prepare_cage_sum_cnn_data.py
          echo "Cage sum CNN data preparation complete"

      - name: Train Cage Sum CNN
        if: inputs.model_type == 'cage-sum-cnn' || inputs.model_type == 'all' || github.event_name == 'schedule'
        run: |
          cd extraction_service
          echo "Training Cage Sum CNN..."
          python train_cage_sum_cnn.py --epochs 30 --batch-size 32
          echo "Cage Sum CNN training complete"
          ls -lh models/cage_sum_cnn.pth

      - name: Upload retrained models
        uses: actions/upload-artifact@v4
        with:
          name: retrained-models-${{ github.run_number }}
          path: |
            extraction_service/models/digit_cnn.pth
            extraction_service/models/boundary_classifier_rf.pkl
            extraction_service/models/boundary_scaler.pkl
            extraction_service/models/cage_sum_cnn.pth
          retention-days: 30

      - name: Create summary
        run: |
          echo "## Model Retraining Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model type:** ${{ inputs.model_type || 'all (scheduled)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Model Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh extraction_service/models/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Models are available as artifacts. To deploy, download and commit them to main." >> $GITHUB_STEP_SUMMARY
